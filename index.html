<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Organisations & Virements</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
body {
  font-family: 'Press Start 2P', cursive;
  background: linear-gradient(to bottom, #0d0d3f, #00001a);
  color: #fff;
  padding: 30px;
  text-align: center;
}

input, button, select {
  font-family: 'Press Start 2P', cursive;
  padding: 15px;
  margin: 8px;
  border: none;
  outline: none;
  border-radius: 8px;
}

input, select {
  width: 80%;
  font-size: 12px;
}

button {
  background: #0099ff;
  color: #fff;
  cursor: pointer;
  font-size: 12px;
  box-shadow: 0 4px 0 #0066aa;
  transition: all 0.2s;
}

button:hover {
  background: #0077cc;
  box-shadow: 0 2px 0 #004c80;
}

.popup, .modal {
  background: #001d3d;
  border: 2px solid #0099ff;
  padding: 20px;
  width: 340px;
  margin: 20px auto;
  box-shadow: 0 0 15px #0099ff;
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 50, 0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-overlay.active {
  display: flex;
}

.notification {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: #0077cc;
  padding: 10px;
  border-radius: 5px;
  display: none;
  font-size: 11px;
  box-shadow: 0 0 8px #0099ff;
  color: white;
}

#main {
  max-width: 1000px;
  margin: auto;
  display: flex;
  justify-content: space-between;
}

#org-list, #online-users {
  width: 30%;
}

#center-panel {
  width: 35%;
}

#org-list > div, #online-users > div {
  margin-top: 15px;
  padding: 10px;
  background: #001d3d;
  border: 2px solid #0099ff;
  text-align: left;
  color: white;
}

h1, h2, h3 {
  color: #00ccff;
  text-shadow: 1px 1px 2px #000;
}

/* Boîte organisation */
.organisation-box {
  border: 2px solid #0099ff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  background-color: #ffffff;
  color: #000033;
  font-family: 'Press Start 2P', cursive;
  font-size: 12px;
  text-align: center;
  box-shadow: 0 0 10px #0099ff;
}

/* Contenu organisation */
.org-content {
  margin-bottom: 20px;
  line-height: 2;
  font-size: 14px;
}

/* Balance mise en avant */
.org-content strong:first-child {
  display: block;
  font-size: 18px;
  color: #0066cc;
  margin-bottom: 10px;
}

.org-content::after {
  content: "💰";
  display: block;
  font-size: 22px;
  margin-top: 10px;
}

/* Boutons */
.org-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
}

.org-buttons button {
  padding: 12px 20px;
  font-size: 12px;
  border: none;
  border-radius: 8px;
  background-color: #0099ff;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 0 #0066aa;
  transition: all 0.2s;
  width: 80%;
}

.org-buttons button:hover {
  background-color: #0077cc;
  box-shadow: 0 2px 0 #004c80;
}


  </style>
</head>
<body>
  <div id="auth-popup" class="popup">
    <h2>Connexion</h2>
    <input id="username" placeholder="Pseudo" /><br>
    <input id="password" type="password" placeholder="Mot de passe" /><br>
    <button id="login-btn">Connexion</button>
    <button id="signup-btn">Inscription</button>
  </div>

  <div id="main" style="display:none;">
    <div id="org-list">
      <h3>Organisations</h3>
    </div>
    <div id="center-panel">
      <h1>Bienvenue !</h1>
      <div id="balance">Balance: <span id="user-balance">00,00µ</span></div>
      <button id="new-org">Nouvelle organisation</button>
      <button id="virement">Virement</button>
    </div>
    <div id="online-users">
      <h3>En ligne</h3>
    </div>
  </div>

  <div id="notification" class="notification"></div>
  <audio id="chime" src="chime.mp3"></audio>

  <div class="modal-overlay" id="virement-modal">
    <div class="modal">
      <h3>Faire un virement</h3>
      <input id="virement-montant" placeholder="Montant (ex: 01,00µ)" />
      <input id="virement-destinataire" placeholder="Pseudo (ou vide)" />
      <select id="virement-organisation">
        <option value="">Aucune organisation</option>
      </select>
      <br><br>
      <button id="confirm-virement">Envoyer</button>
      <button onclick="toggleModal(false)">Annuler</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain: "kykychat-24c7f.firebaseapp.com",
  projectId: "kykychat-24c7f",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

const loginBtn = document.getElementById('login-btn');
const signupBtn = document.getElementById('signup-btn');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const userBalance = document.getElementById('user-balance');
const orgList = document.getElementById('org-list');
const chime = document.getElementById('chime');
const notif = document.getElementById('notification');
const onlineUsers = document.getElementById('online-users');

const modal = document.getElementById('virement-modal');
const montantInput = document.getElementById('virement-montant');
const destinataireInput = document.getElementById('virement-destinataire');
const organisationSelect = document.getElementById('virement-organisation');

function toggleModal(show = true) {
  modal.classList.toggle("active", show);
  if (show) {
    montantInput.value = "";
    destinataireInput.value = "";
    organisationSelect.innerHTML = `<option value="">Aucune organisation</option>`;
    db.collection('organisations').get().then(snapshot => {
      snapshot.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.data().name;
        organisationSelect.appendChild(opt);
      });
    });
  }
}

async function updateBalanceUI() {
  const userRef = db.collection('users').doc(currentUser.displayName);
  const doc = await userRef.get();
  const balance = doc.exists ? doc.data().balance || 0 : 0;
  userBalance.textContent = balance.toFixed(2) + 'µ';
}
function listenToBalanceChanges() {
  const userRef = db.collection('users').doc(currentUser.displayName);
  userRef.onSnapshot(doc => {
    if (doc.exists) {
      const balance = doc.data().balance || 0;
      userBalance.textContent = balance.toFixed(2) + 'µ';
    }
  });
}

function showNotification(msg) {
  notif.textContent = msg;
  notif.style.display = 'block';
  chime.play();
  setTimeout(() => notif.style.display = 'none', 5000);
}


async function listenToIncomingTransfers() {
  db.collection('virements')
    .where("to", "==", currentUser.displayName)
    .where("seen", "==", false)
    .onSnapshot(snapshot => {
      snapshot.forEach(async doc => {
        const data = doc.data();
        showNotification(`${data.from} vous a envoyé ${data.amount.toFixed(2)}µ`);
        await db.collection('virements').doc(doc.id).update({ seen: true });
      });
    });
}

function listenToOrganisationTransfers() {
  const userPseudo = currentUser.displayName;

  db.collection("organisations")
    .where("members", "array-contains", userPseudo)
    .onSnapshot((snapshot) => {
      const orgMap = {};
      snapshot.forEach((doc) => {
        orgMap[doc.id] = doc.data().name;
      });

      if (Object.keys(orgMap).length === 0) return;

      // Attention : on ne peut pas faire un .where("seenBy", "not-in", [...]) si liste vide → on vérifie manuellement
      db.collection("org_transfers")
        .where("orgId", "in", Object.keys(orgMap))
        .orderBy("timestamp", "desc")
        .limit(10)
        .onSnapshot((snap) => {
          snap.docChanges().forEach(async (change) => {
            if (change.type === "added") {
              const doc = change.doc;
              const data = doc.data();
              const seenBy = data.seenBy || [];

              if (!seenBy.includes(userPseudo)) {
                const orgName = orgMap[data.orgId] || "une organisation";
                showNotification(`${data.from} a fait un virement de ${data.amount.toFixed(2)}µ à l'organisation ${orgName}`);

                await db.collection("org_transfers").doc(doc.id).update({
                  seenBy: firebase.firestore.FieldValue.arrayUnion(userPseudo)
                });
              }
            }
          });
        });
    });
}



async function loadOrganisations() {
  orgList.innerHTML = "<h3>Organisations</h3>";
  const snap = await db.collection('organisations')
    .where('members', 'array-contains', currentUser.displayName).get();

  snap.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.classList.add("organisation-box");

    const html = `
      <div class="org-content">
        <strong>${data.name}</strong><br>
        Créé par: ${data.creator}<br>
        Balance: ${data.balance.toFixed(2)}µ
      </div>
      <div class="org-buttons">
        <button class="recuperer-btn" data-orgid="${doc.id}" data-balance="${data.balance}">Récupérer</button>
        <button class="ajouter-btn" data-orgid="${doc.id}">Ajouter membre</button>
      </div>
    `;

    div.innerHTML = html;
    orgList.appendChild(div);
  });

  // Ajout des listeners après génération
  document.querySelectorAll(".recuperer-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const orgId = btn.dataset.orgid;
      const balance = parseFloat(btn.dataset.balance);
      const input = prompt("Combien voulez-vous récupérer ?");
      if (!input) return;
      const montant = parseFloat(input.replace(",", "."));
      if (isNaN(montant) || montant <= 0 || montant > balance) {
        return alert("Montant invalide !");
      }

      await db.collection('organisations').doc(orgId).update({
        balance: firebase.firestore.FieldValue.increment(-montant)
      });

      await db.collection('users').doc(currentUser.displayName).update({
        balance: firebase.firestore.FieldValue.increment(montant)
      });

      updateBalanceUI();
      loadOrganisations(); // Recharge les données
    });
  });

  document.querySelectorAll(".ajouter-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const orgId = btn.dataset.orgid;
      const pseudo = prompt("Pseudo de la personne à ajouter à l'organisation ?");
      if (!pseudo) return;

      const userRef = db.collection('users').doc(pseudo);
      const userSnap = await userRef.get();
      if (!userSnap.exists) return alert("Utilisateur introuvable.");

      const orgRef = db.collection('organisations').doc(orgId);
      await orgRef.update({
        members: firebase.firestore.FieldValue.arrayUnion(pseudo)
      });

      alert(`${pseudo} ajouté à l'organisation !`);
      loadOrganisations();
    });
  });
}


async function loadOnlineUsers() {
  onlineUsers.innerHTML = "<h3>En ligne</h3>";
  const snap = await db.collection('users').where('online', '==', true).get();
  snap.forEach(doc => {
    const div = document.createElement("div");
    div.textContent = doc.id;
    onlineUsers.appendChild(div);
  });
}

async function setOnlineStatus(status) {
  if (currentUser) {
    const userRef = db.collection('users').doc(currentUser.displayName);
    const doc = await userRef.get();
    const existingBalance = doc.exists && doc.data().balance !== undefined ? doc.data().balance : 50;
    await userRef.set({
      online: status,
      balance: existingBalance
    }, { merge: true });
  }
}

async function initApp() {
  document.getElementById('auth-popup').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  await setOnlineStatus(true);
  updateBalanceUI();
  loadOrganisations();
  loadOnlineUsers();
  listenToIncomingTransfers();
  listenToOrganisationTransfers();
  listenToBalanceChanges(); // ← Ajout ici
  setInterval(loadOnlineUsers, 10000);
}

loginBtn.onclick = async () => {
  try {
    const email = usernameInput.value + "@mail.com";
    const pass = passwordInput.value;
    await auth.signInWithEmailAndPassword(email, pass);
    currentUser = { displayName: usernameInput.value };
    await setOnlineStatus(true);
    initApp();
  } catch {
    alert("Erreur de connexion !");
  }
};

signupBtn.onclick = async () => {
  try {
    const email = usernameInput.value + "@mail.com";
    const pass = passwordInput.value;
    await auth.createUserWithEmailAndPassword(email, pass);
    currentUser = { displayName: usernameInput.value };
    await db.collection('users').doc(usernameInput.value).set({
      balance: 50,
      online: true
    });
    initApp();
  } catch {
    alert("Erreur d'inscription !");
  }
};

document.getElementById('new-org').onclick = async () => {
  const name = prompt("Nom de l'organisation");
  if (!name) return;
  await db.collection('organisations').add({
    name,
    creator: currentUser.displayName,
    balance: 0,
    members: [currentUser.displayName],
    lastAmount: 0,
    lastFrom: ""
  });
  loadOrganisations();
};

document.getElementById('virement').onclick = () => toggleModal(true);

document.getElementById('confirm-virement').onclick = async () => {
  try {
    const montant = parseFloat(montantInput.value.replace(",", "."));
    const destinataire = destinataireInput.value.trim();
    const orgId = organisationSelect.value;

    if (isNaN(montant) || montant <= 0) return alert("Montant invalide !");
    if (!currentUser) return alert("Utilisateur non connecté.");

    const userRef = db.collection('users').doc(currentUser.displayName);
    const userSnap = await userRef.get();
    const solde = userSnap.data().balance || 0;
    if (solde < montant) return alert("Pas assez d'argent !");

    if (destinataire) {
      const destRef = db.collection('users').doc(destinataire);
      const destSnap = await destRef.get();
      if (destSnap.exists) {
        await destRef.update({
          balance: firebase.firestore.FieldValue.increment(montant)
        });
        await db.collection('virements').add({
          to: destinataire,
          from: currentUser.displayName,
          amount: montant,
          seen: false
        });

        await db.collection('logs').add({
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          message: `${currentUser.displayName} a fait un virement de ${montant.toFixed(2)}µ à ${destinataire}`
        });
      } else {
        return alert("Destinataire introuvable !");
      }
    } else if (orgId) {
      const orgRef = db.collection('organisations').doc(orgId);
      const orgSnap = await orgRef.get();
      const orgName = orgSnap.exists ? orgSnap.data().name : "une organisation";

      await orgRef.update({
        balance: firebase.firestore.FieldValue.increment(montant),
        lastAmount: montant,
        lastFrom: currentUser.displayName
      });

      await db.collection('org_transfers').add({
        orgId: orgId,
        amount: montant,
        from: currentUser.displayName,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        seenBy: []
      });

      await db.collection('logs').add({
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        message: `${currentUser.displayName} a fait un virement de ${montant.toFixed(2)}µ à l'organisation ${orgName}`
      });
    } else {
      return alert("Veuillez saisir un destinataire ou choisir une organisation.");
    }

    await userRef.update({
      balance: firebase.firestore.FieldValue.increment(-montant)
    });

    toggleModal(false);
    updateBalanceUI();
    loadOrganisations();
  } catch (err) {
    console.error("Erreur lors du virement :", err);
    alert("Une erreur est survenue lors du virement.");
  }
};

    // 🔹 Ajout du log personnel
    await db.collection('logs').add({
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: `${currentUser.displayName} a fait un virement de ${montant.toFixed(2)}µ à ${destinataire}`
    });
  }
} else if (orgId) {
  const orgRef = db.collection('organisations').doc(orgId);
  const orgSnap = await orgRef.get();
  const orgName = orgSnap.exists ? orgSnap.data().name : "une organisation";

  await orgRef.update({
    balance: firebase.firestore.FieldValue.increment(montant),
    lastAmount: montant,
    lastFrom: currentUser.displayName
  });

  await db.collection('org_transfers').add({
    orgId: orgId,
    amount: montant,
    from: currentUser.displayName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    seenBy: []
  });

  // 🔹 Ajout du log organisation
  await db.collection('logs').add({
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `${currentUser.displayName} a fait un virement de ${montant.toFixed(2)}µ à l'organisation ${o


  await userRef.update({
    balance: firebase.firestore.FieldValue.increment(-montant)
  });

  toggleModal(false);
  updateBalanceUI();
  loadOrganisations();
};

window.addEventListener("beforeunload", () => setOnlineStatus(false));



</script>

</body>
</html>
