<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Organisations & Virements</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Press Start 2P', cursive;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: #121212;
      color: #fff;
      display: flex;
      height: 100vh;
    }

    #orgs, #onlineUsers {
      width: 20%;
      background: #1e1e1e;
      padding: 10px;
      overflow-y: auto;
    }

    #main {
      flex: 1;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    button {
      background: #00cc88;
      border: none;
      color: white;
      padding: 10px;
      margin: 10px;
      cursor: pointer;
    }

    .popup, .transfer-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c2c2c;
      padding: 30px;
      border: 3px solid white;
      display: none;
      z-index: 10;
    }

    .popup input, .transfer-popup input, select {
      margin: 10px;
      padding: 10px;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      width: 80%;
    }

    .notif {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #ccc;
      color: black;
      padding: 10px;
      z-index: 20;
      display: none;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="orgs">
    <h3>Organisations</h3>
    <ul id="orgList"></ul>
  </div>

  <div id="main">
    <h2>Balance: <span id="userBalance">--,--µ</span></h2>
    <button onclick="showOrgPopup()">Nouvelle organisation</button>
    <button onclick="showTransferPopup()">Virement</button>
    <ul id="myOrgs"></ul>
  </div>

  <div id="onlineUsers">
    <h3>En ligne</h3>
    <ul id="userList"></ul>
  </div>

  <!-- Login -->
  <div class="popup" id="loginPopup">
    <h3>Connexion</h3>
    <input id="loginPseudo" placeholder="Pseudo">
    <input id="loginPass" type="password" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>
    <button onclick="register()">S'inscrire</button>
  </div>

  <!-- Organisation popup -->
  <div class="popup" id="orgPopup">
    <input id="newOrgName" placeholder="Nom organisation">
    <button onclick="createOrg()">Créer</button>
  </div>

  <!-- Virement popup -->
  <div class="transfer-popup" id="transferPopup">
    <input id="amount" placeholder="Montant (ex: 01,00)">
    <input id="toUser" placeholder="Pseudo destinataire (facultatif)">
    <select id="orgSelect">
      <option value="">Organisation (facultatif)</option>
    </select>
    <button onclick="makeTransfer()">Envoyer</button>
  </div>

  <!-- Notification -->
  <div class="notif" id="notif"></div>

  <audio id="chime" src="chime.mp3" preload="auto"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
      authDomain: "kykychat-24c7f.firebaseapp.com",
      databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
      projectId: "kykychat-24c7f",
      storageBucket: "kykychat-24c7f.firebasestorage.app",
      messagingSenderId: "342562811927",
      appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser;

    window.onload = () => {
      document.getElementById("loginPopup").style.display = "block";
    };

    function login() {
      const email = loginPseudo.value + "@domain.com";
      const pass = loginPass.value;
      auth.signInWithEmailAndPassword(email, pass).then(() => {
        document.getElementById("loginPopup").style.display = "none";
        afterLogin();
      });
    }

    function register() {
      const email = loginPseudo.value + "@domain.com";
      const pass = loginPass.value;
      auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
        db.ref("users/" + loginPseudo.value).set({ balance: 50.00 });
        document.getElementById("loginPopup").style.display = "none";
        afterLogin();
      });
    }

    function afterLogin() {
      currentUser = auth.currentUser.email.split("@")[0];
      db.ref("online/" + currentUser).set(true);
      db.ref("online/" + currentUser).onDisconnect().remove();

      db.ref("users/" + currentUser + "/balance").on("value", snap => {
        const val = snap.val() || 0;
        userBalance.textContent = val.toFixed(2).replace(".", ",") + "µ";
      });

      db.ref("organisations").on("value", snap => {
        const orgList = orgListEl => {
          orgListEl.innerHTML = '';
          Object.entries(snap.val() || {}).forEach(([name, data]) => {
            const li = document.createElement("li");
            li.textContent = name;
            li.onclick = () => showOrgDetails(name);
            orgListEl.appendChild(li);
          });
        };
        orgList(orgList);
        updateOrgDropdown(snap.val());
      });

      db.ref("users").on("value", snap => {
        const userList = document.getElementById("userList");
        userList.innerHTML = '';
        Object.keys(snap.val() || {}).forEach(u => {
          if (snap.val()[u]) {
            const li = document.createElement("li");
            li.textContent = u;
            userList.appendChild(li);
          }
        });
      });

      db.ref("online").on("value", snap => {
        const online = Object.keys(snap.val() || {});
        const userList = document.getElementById("userList");
        userList.innerHTML = '';
        online.forEach(user => {
          const li = document.createElement("li");
          li.textContent = user;
          userList.appendChild(li);
        });
      });

      db.ref("transfers").on("child_added", snap => {
        const t = snap.val();
        if (t.to === currentUser) {
          showNotif(`${t.from} vous a fait un virement de ${t.amount.replace(".", ",")}µ!`);
          document.getElementById("chime").play();
        } else if (t.org && isInOrg(t.org)) {
          showNotif(`${t.from} a fait un virement de ${t.amount.replace(".", ",")}µ à l'organisation ${t.org}!`);
          document.getElementById("chime").play();
        }
      });

      loadMyOrgs();
    }

    function showNotif(text) {
      notif.textContent = text;
      notif.style.display = "block";
      setTimeout(() => notif.style.display = "none", 5000);
    }

    function showOrgPopup() {
      orgPopup.style.display = "block";
    }

    function createOrg() {
      const name = newOrgName.value;
      db.ref("organisations/" + name).set({ creator: currentUser, balance: 0, members: { [currentUser]: true } });
      orgPopup.style.display = "none";
      loadMyOrgs();
    }

    function loadMyOrgs() {
      db.ref("organisations").once("value", snap => {
        myOrgs.innerHTML = '';
        Object.entries(snap.val() || {}).forEach(([name, data]) => {
          if (data.members && data.members[currentUser]) {
            const li = document.createElement("li");
            li.innerHTML = `${name}<br><small>Créateur: ${data.creator}</small><br>Balance: ${data.balance.toFixed(2).replace(".", ",")}µ<br><button onclick="addMember('${name}')">Ajouter</button>`;
            myOrgs.appendChild(li);
          }
        });
      });
    }

    function addMember(orgName) {
      const pseudo = prompt("Pseudo à ajouter :");
      db.ref("organisations/" + orgName + "/members/" + pseudo).set(true);
    }

    function updateOrgDropdown(data) {
      orgSelect.innerHTML = '<option value="">Organisation (facultatif)</option>';
      Object.keys(data || {}).forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        orgSelect.appendChild(option);
      });
    }

    function showTransferPopup() {
      transferPopup.style.display = "block";
    }

    function makeTransfer() {
      const amount = parseFloat(amountInput.value.replace(",", "."));
      const toUser = toUserInput.value;
      const toOrg = orgSelect.value;

      db.ref("users/" + currentUser + "/balance").once("value", snap => {
        const bal = snap.val() || 0;
        if (amount > bal) return alert("Fonds insuffisants");

        db.ref("users/" + currentUser + "/balance").set(bal - amount);
        if (toUser) {
          db.ref("users/" + toUser + "/balance").once("value", s => {
            const b = s.val() || 0;
            db.ref("users/" + toUser + "/balance").set(b + amount);
            db.ref("transfers").push({ from: currentUser, to: toUser, amount });
          });
        } else if (toOrg) {
          db.ref("organisations/" + toOrg + "/balance").once("value", s => {
            const b = s.val() || 0;
            db.ref("organisations/" + toOrg + "/balance").set(b + amount);
            db.ref("transfers").push({ from: currentUser, org: toOrg, amount });
          });
        }

        transferPopup.style.display = "none";
      });
    }

    function isInOrg(orgName) {
      const orgs = document.querySelectorAll("#myOrgs li");
      return [...orgs].some(li => li.innerHTML.includes(orgName));
    }

    function showOrgDetails(name) {
      alert("TODO: Voir détails ou membres — déjà dans votre liste s’ils vous ont ajouté.");
    }
  </script>
</body>
</html>

